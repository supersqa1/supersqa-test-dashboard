name: CI/CD Pipeline

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

env:
  PY_IMAGE: python:3.11
  APP_DIR: /root/projects/automation_dashboard

jobs:
  code_quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install .[dev]
      - name: Run pylint
        run: |
          pylint ./automationdashboard --recursive=true -E

  deploy_to_staging:
    needs: code_quality
    # if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: staging
    env:
      ENVIRONMENT: staging
      APP_INSTANCE_DIR: /root/projects/automation_dashboard/staging
      VIRTUAL_ENVIRONMENT: /root/projects/automation_dashboard/staging/venv_dashboard
      PORT: 9099
      REMOTE_HOST_IP: ${{ secrets.REMOTE_HOST_IP }}
      DRP3_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      REMOTE_SSH_USER: root
      STAGING_DB_HOST: ${{ secrets.STAGING_DB_HOST }}
      STAGING_DB_PORT: ${{ secrets.STAGING_DB_PORT }}
      STAGING_DB_USER: ${{ secrets.STAGING_DB_USER }}
      STAGING_DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          # Debug the secret content
          echo "Secret length: ${#SSH_PRIVATE_KEY}"
          echo "First 50 chars of secret: ${SSH_PRIVATE_KEY:0:50}"
          echo "Last 50 chars of secret: ${SSH_PRIVATE_KEY: -50}"
          
          # Write the key with proper formatting
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          
          # Debug the written file
          echo "File size: $(stat -c %s ~/.ssh/deploy_key)"
          echo "File content:"
          cat ~/.ssh/deploy_key
          
          # Ensure proper permissions
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known hosts
          ssh-keyscan -t rsa ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -t ecdsa ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -t ed25519 ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.REMOTE_HOST_IP }} 'echo "SSH connection successful"'
      - name: Debug environment variables
        run: |
          echo "REMOTE_HOST_IP is set: $([[ -n "$REMOTE_HOST_IP" ]] && echo "yes" || echo "no")"
          echo "DRP3_KEY is set: $([[ -n "$DRP3_KEY" ]] && echo "yes" || echo "no")"
          echo "REMOTE_SSH_USER is set: $([[ -n "$REMOTE_SSH_USER" ]] && echo "yes" || echo "no")"
          ls -la ~/.ssh/deploy_key
      - name: Deploy to staging
        run: bash deploy.sh

  uat_automation:
    needs: deploy_to_staging
    # if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container: 
      image: python:3.11
    services:
      selenium:
        image: selenium/standalone-firefox
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          pip install .[dev]
      - name: Run UAT tests
        run: |
          pytest -m healthcheck ./uat_automation/tests

  deploy_to_prod:
    needs: [deploy_to_staging, uat_automation]
    # if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    env:
      ENVIRONMENT: prod
      APP_INSTANCE_DIR: /root/projects/automation_dashboard/prod
      VIRTUAL_ENVIRONMENT: /root/projects/automation_dashboard/prod/venv_dashboard
      PORT: 9098
      REMOTE_HOST_IP: ${{ secrets.REMOTE_HOST_IP }}
      DRP3_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      REMOTE_SSH_USER: root
      PROD_DB_HOST: ${{ secrets.PROD_DB_HOST }}
      PROD_DB_PORT: ${{ secrets.PROD_DB_PORT }}
      PROD_DB_USER: ${{ secrets.PROD_DB_USER }}
      PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          # Debug the secret content
          echo "Secret length: ${#SSH_PRIVATE_KEY}"
          echo "First 50 chars of secret: ${SSH_PRIVATE_KEY:0:50}"
          echo "Last 50 chars of secret: ${SSH_PRIVATE_KEY: -50}"
          
          # Write the key with proper formatting
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          
          # Debug the written file
          echo "File size: $(stat -c %s ~/.ssh/deploy_key)"
          echo "File content:"
          cat ~/.ssh/deploy_key
          
          # Ensure proper permissions
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known hosts
          ssh-keyscan -t rsa ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -t ecdsa ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -t ed25519 ${{ secrets.REMOTE_HOST_IP }} >> ~/.ssh/known_hosts
          
          # Test SSH connection
          echo "Testing SSH connection..."
          ssh -v -o StrictHostKeyChecking=no -i ~/.ssh/deploy_key ${{ secrets.REMOTE_HOST_IP }} 'echo "SSH connection successful"'
      - name: Debug environment variables
        run: |
          echo "REMOTE_HOST_IP is set: $([[ -n "$REMOTE_HOST_IP" ]] && echo "yes" || echo "no")"
          echo "DRP3_KEY is set: $([[ -n "$DRP3_KEY" ]] && echo "yes" || echo "no")"
          echo "REMOTE_SSH_USER is set: $([[ -n "$REMOTE_SSH_USER" ]] && echo "yes" || echo "no")"
          ls -la ~/.ssh/deploy_key
      - name: Deploy to production
        run: bash deploy.sh 